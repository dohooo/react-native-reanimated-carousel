name: E2E Tests

on:
  pull_request:
  push:
    branches: [main]

jobs:
  e2e-ios:
    runs-on: macos-15
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Show Xcode version
        id: xcode-version
        run: |
          set -euxo pipefail
          xcodebuild -version
          XCODE_VERSION=$(xcodebuild -version | tr '\n' ' ' | sed 's/  */-/g; s/[^A-Za-z0-9._-]/-/g')
          echo "version=${XCODE_VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: |
          set -euxo pipefail
          retry() {
            local max_retries="$1"
            shift
            local attempt=1
            until "$@"; do
              if [ "$attempt" -ge "$max_retries" ]; then
                echo "Command failed after ${attempt} attempts: $*"
                return 1
              fi
              attempt=$((attempt + 1))
              echo "Retrying (${attempt}/${max_retries}): $*"
              sleep 10
            done
          }

          retry 3 yarn install --frozen-lockfile
          cd example/app
          retry 3 yarn install --frozen-lockfile

      - name: Setup Java (required by Maestro)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Boot iOS Simulators
        run: |
          DEVICE_NAME="iPhone 16"
          # Find the iOS runtime identifier
          RUNTIME=$(xcrun simctl list runtimes available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for r in data['runtimes']:
              if 'iOS' in r.get('name', ''):
                  print(r['identifier'])
                  sys.exit(0)
          sys.exit(1)
          ")
          echo "Using runtime: $RUNTIME"

          # Create and boot 2 simulators for sharded test execution
          SIM1_UDID=$(xcrun simctl create "E2E-1" "$DEVICE_NAME" "$RUNTIME")
          SIM2_UDID=$(xcrun simctl create "E2E-2" "$DEVICE_NAME" "$RUNTIME")
          xcrun simctl boot "$SIM1_UDID"
          xcrun simctl boot "$SIM2_UDID"

          echo "SIMULATOR_UDID=$SIM1_UDID" >> "$GITHUB_ENV"
          echo "SIMULATOR_UDID_2=$SIM2_UDID" >> "$GITHUB_ENV"
          echo "SIMULATOR_NAME=$DEVICE_NAME" >> "$GITHUB_ENV"

      - name: Restore CocoaPods download cache
        id: cocoapods-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ~/.cocoapods/repos
          key: ${{ runner.os }}-${{ steps.xcode-version.outputs.version }}-cocoapods-${{ hashFiles('example/app/yarn.lock', 'example/app/package.json') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.xcode-version.outputs.version }}-cocoapods-

      - name: Prebuild iOS
        working-directory: example/app
        run: npx expo prebuild --platform ios --non-interactive

      - name: Save CocoaPods download cache
        if: always() && steps.cocoapods-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ~/.cocoapods/repos
          key: ${{ runner.os }}-${{ steps.xcode-version.outputs.version }}-cocoapods-${{ hashFiles('example/app/yarn.lock', 'example/app/package.json') }}

      - name: Verify generated iOS workspace
        run: test -d example/app/ios/app.xcworkspace

      - name: Restore iOS app build cache
        id: restore-ios-build-cache
        uses: actions/cache/restore@v4
        with:
          path: example/app/ios/build
          key: ${{ runner.os }}-${{ steps.xcode-version.outputs.version }}-ios-build-${{ hashFiles('yarn.lock', 'example/app/yarn.lock', 'example/app/package.json', 'example/app/app.json', 'example/app/ios/Podfile.lock', 'example/app/ios/**/*.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.xcode-version.outputs.version }}-ios-build-

      - name: Check cached app bundle
        id: cached-app
        run: |
          if [ -d example/app/ios/build/Build/Products/Release-iphonesimulator/app.app ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build for iOS Simulator
        if: steps.cached-app.outputs.exists != 'true'
        working-directory: example/app/ios
        run: |
          set -o pipefail
          xcodebuild \
            -workspace app.xcworkspace \
            -scheme app \
            -configuration Release \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=${SIMULATOR_UDID}" \
            -derivedDataPath build \
            build | tee xcodebuild.log

      - name: Check built app bundle after build step
        if: always()
        id: built-app-after-build
        run: |
          if [ -d example/app/ios/build/Build/Products/Release-iphonesimulator/app.app ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Save iOS app build cache
        if: always() && steps.restore-ios-build-cache.outputs.cache-hit != 'true' && steps.built-app-after-build.outputs.exists == 'true'
        uses: actions/cache/save@v4
        with:
          path: example/app/ios/build
          key: ${{ runner.os }}-${{ steps.xcode-version.outputs.version }}-ios-build-${{ hashFiles('yarn.lock', 'example/app/yarn.lock', 'example/app/package.json', 'example/app/app.json', 'example/app/ios/Podfile.lock', 'example/app/ios/**/*.pbxproj') }}

      - name: Reuse cached iOS app build
        if: steps.cached-app.outputs.exists == 'true'
        run: |
          echo "Using cached app bundle, skipping xcodebuild."
          ls -lah example/app/ios/build/Build/Products/Release-iphonesimulator/app.app

      - name: Install app on Simulators
        run: |
          APP_PATH=example/app/ios/build/Build/Products/Release-iphonesimulator/app.app
          xcrun simctl install "$SIMULATOR_UDID" "$APP_PATH"
          xcrun simctl install "$SIMULATOR_UDID_2" "$APP_PATH"

      - name: Run E2E tests (sharded across 2 simulators)
        run: |
          set -euxo pipefail
          xcrun simctl launch "$SIMULATOR_UDID" com.react-native-reanimated-carousel.example
          xcrun simctl launch "$SIMULATOR_UDID_2" com.react-native-reanimated-carousel.example
          sleep 5
          maestro --shard-split 2 test "$GITHUB_WORKSPACE/e2e/" | tee /tmp/maestro.log

      - name: Collect CI debug artifacts
        if: always()
        run: |
          set -euxo pipefail
          mkdir -p /tmp/e2e-debug
          cp -f /tmp/maestro.log /tmp/e2e-debug/maestro.log || true
          cp -f example/app/ios/xcodebuild.log /tmp/e2e-debug/xcodebuild.log || true
          xcrun simctl list devices > /tmp/e2e-debug/simctl-devices.txt || true
          xcrun simctl io "$SIMULATOR_UDID" screenshot /tmp/e2e-debug/final-sim1-screen.png || true
          xcrun simctl io "$SIMULATOR_UDID_2" screenshot /tmp/e2e-debug/final-sim2-screen.png || true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          if-no-files-found: warn
          retention-days: 7
          path: |
            ~/.maestro/tests/
            /tmp/e2e-debug/
